IMPLEMENTATION_NOTES (СОПРОВОДИТЕЛЬНОЕ).
Обзор проекта
технические решения и подходы, которые были использованы при разработке мини-CRM системы для сбора и обработки заявок.

Выполненные требования
Основной функционал
Миграции и структура БД:
Созданы миграции для всех основных сущностей системы: пользователи, клиенты и заявки. Дополнительно интегрированы таблицы для системы ролей (Spatie Permission) и управления медиафайлами (Spatie Media Library). Все миграции содержат индексы для оптимизации запросов по часто используемым полям.
Тестовые данные:
Реализованы фабрики для автоматической генерации тестовых данных. Seeders настроены для создания двух тестовых аккаунтов (администратор и менеджер), клиентов и заявок. Это позволяет быстро развернуть рабочее окружение для демонстрации и тестирования.
Система ролей:
Использован пакет Spatie Laravel Permission для управления правами доступа. Реализованы две роли: администратор и менеджер. Обе роли имеют доступ к просмотру и управлению заявками, но система спроектирована с возможностью гибкого разграничения прав в будущем.
Архитектура кода:
Вся бизнес-логика вынесена в отдельный слой сервисов. Контроллеры выполняют только роль маршрутизаторов запросов. Работа с базой данных изолирована в репозиториях, что обеспечивает легкую замену источника данных при необходимости.
Валидация данных:
Вся валидация входящих данных осуществляется через специализированные Form Request классы. Особое внимание уделено валидации номеров телефонов - они проверяются на соответствие международному формату E.164.
Соответствие стандартам:
Код следует принципам SOLID, что делает систему расширяемой и поддерживаемой. Применяются паттерны MVC, Repository и Service Layer. Код отформатирован согласно стандарту PSR-12 с использованием Laravel Pint.
Контроль версий:
Разработка велась с использованием Git.
Виджет обратной связи
Создана отдельная страница с формой для отправки заявок. Виджет полностью автономен и может быть интегрирован на любой сторонний сайт через iframe. Все стили и скрипты изолированы, что предотвращает конфликты с CSS и JavaScript на родительской странице.
Форма отправляет данные через AJAX без перезагрузки страницы. Реализована полная обработка ошибок валидации с выводом понятных сообщений пользователю. При успешной отправке форма очищается и показывается сообщение с подтверждением.
API эндпоинты
Создание заявки (POST /api/tickets):
Принимает данные клиента и текст обращения. Автоматически создает или находит существующего клиента по email. Поддерживает прикрепление до 5 файлов общим размером до 10MB каждый. Все ответы формируются через API Resources для единообразного формата данных.
Статистика заявок (GET /api/tickets/statistics):
Возвращает агрегированные данные по количеству заявок за выбранный период. Поддерживает три периода: день, неделя и месяц. Для подсчета используются Eloquent scopes и функции Carbon для работы с датами.
Административная панель
Разработан полноценный интерфейс для управления заявками. Главная страница отображает статистику в трех временных разрезах с разбивкой по статусам обработки.
Список заявок представлен в виде таблицы с возможностью фильтрации по нескольким параметрам одновременно. Реализована пагинация для комфортной работы с большим количеством данных.
Страница детального просмотра заявки содержит всю информацию о клиенте, текст обращения и список прикрепленных файлов. Каждый файл можно скачать по прямой ссылке. Присутствует форма для изменения статуса заявки.
Доступ к админке защищен middleware аутентификации и проверкой наличия соответствующей роли.

Архитектурные решения
Repository Pattern
Выбран паттерн Repository для изоляции логики работы с данными. Каждый репозиторий реализует интерфейс, что позволяет легко заменять реализацию без изменения остального кода.
Преимущества в проекте:

Сервисный слой не зависит от конкретной ORM
Упрощается написание unit-тестов через мокирование
Вся работа с БД сосредоточена в одном месте

Реализация.
Созданы интерфейсы для работы с клиентами и заявками. Конкретные реализации используют Eloquent ORM. Привязка интерфейсов к реализациям осуществляется через Service Provider.
Service Layer
Вся бизнес-логика приложения вынесена в отдельные сервисы. Контроллеры только принимают HTTP запросы и возвращают ответы.
Основные сервисы:
TicketService - управление заявками. Содержит методы для создания заявок, обновления статусов, получения статистики и проверки дневного лимита. Использует транзакции БД для обеспечения целостности данных при создании связанных записей.
CustomerService - работа с клиентами. Реализует логику поиска существующего клиента или создания нового на основе email адреса.
FileService - управление файлами. Инкапсулирует работу с Spatie Media Library для прикрепления и получения файлов заявок.
Form Request Validation
Валидация полностью отделена от контроллеров и вынесена в специализированные классы.
StoreTicketRequest проверяет данные при создании заявки. Особое внимание уделено валидации телефонного номера через регулярное выражение для формата E.164. Проверяется количество и размер загружаемых файлов.
UpdateTicketStatusRequest валидирует изменение статуса и дополнительно проверяет права пользователя на выполнение операции.
API Resources
Трансформация моделей в JSON выполняется через Resource классы. Это обеспечивает единообразный формат API ответов и скрывает внутреннюю структуру моделей от внешних потребителей.
TicketResource формирует полное представление заявки включая вложенные данные клиента и список файлов.
StatisticsResource структурирует данные статистики для удобного потребления фронтенд частью.

Технические решения
Валидация телефонных номеров
Номера телефонов хранятся и обрабатываются в формате E.164. Это международный стандарт, который обеспечивает уникальность номеров по всему миру.
Формат начинается с символа '+' за которым следует код страны и сам номер. Максимальная длина - 15 цифр. Валидация осуществляется регулярным выражением в Form Request.
Ограничение на отправку заявок
Реализован механизм защиты от спама - не более одной заявки в сутки с одного номера телефона или email адреса.
Проверка выполняется в сервисе перед созданием заявки. Используется комбинированный запрос к репозиторию, который подсчитывает заявки за текущий день от данного клиента. При превышении лимита API возвращает ошибку с кодом 429 (Слишком много запросов).
Работа с файлами
Управление файлами полностью делегировано библиотеке Spatie Media Library. Она автоматически обрабатывает загрузку, хранение и удаление файлов.
Файлы привязываются к заявкам через полиморфные отношения. Каждый файл хранится в отдельной коллекции 'ticket_files'. Библиотека автоматически генерирует уникальные имена файлов и организует файловую структуру.
Статистика заявок
Для подсчета статистики используются Eloquent scopes определенные в модели Ticket. Три scope-метода (today, week, month) фильтруют заявки по дате создания.
Репозиторий выполняет параллельные запросы для подсчета заявок по каждому статусу. Все данные агрегируются в массив и возвращаются через Resource.
Carbon используется для работы с датами и определения временных интервалов.
Фильтрация в админке
Система фильтров построена на передаче параметров через query string. Репозиторий динамически строит запрос в зависимости от переданных фильтров.
Поддерживается фильтрация по дате создания, статусу заявки и данным клиента (email, телефон). Все фильтры могут комбинироваться.

Выбор библиотек
Spatie Laravel Permission
Это стандартное решение для управления ролями в Laravel приложениях. Библиотека активно поддерживается, имеет отличную документацию и проверена временем в production средах.

Основные преимущества.

Простой API для работы с ролями и правами
Встроенное кеширование разрешений
Готовые middleware для проверки доступа
Гибкая система разграничения прав

Альтернативы рассматривались, но не подходят нам.
Встроенные Gates слишком низкоуровневые для управления сложными ролями
Собственная разработка требует значительных временных затрат и тестирования

Spatie Laravel Media Library
Наиболее функциональное решение для управления медиафайлами в Laravel экосистеме.
Ключевые возможности.

Автоматическое управление жизненным циклом файлов
Поддержка различных драйверов хранения (local, S3, etc)
Организация файлов в коллекции
Возможность генерации превью изображений

Библиотека избавляет от необходимости писать boilerplate код для загрузки и хранения файлов, что значительно ускоряет разработку.
Laravel Breeze
Минималистичный starter kit для аутентификации пользователей. Идеально подходит для проектов, где не требуется сложная система управления пользователями.
Выбран из-за простоты и легкости кастомизации. Генерирует готовые контроллеры и views, которые можно адаптировать под нужды проекта.

Особенности реализации
Разделение стилей и разметки
Разделены  CSS и HTML. Все стили вынесены в отдельные файлы в директории public/css.
Для виджета создан файл widget.css со всеми необходимыми стилями для формы, сообщений и анимаций.
Для административной панели разработан файл admin.css с классами для всех компонентов интерфейса.
Blade шаблоны содержат только семантическую разметку и классы.  Это соответствует принципу separation of concerns и облегчает поддержку кода.
JavaScript для виджета
Логика виджета вынесена в отдельный файл widget.js. Используется vanilla JavaScript без зависимостей от внешних библиотек.
Скрипт обрабатывает отправку формы через fetch API, показывает выбранные файлы, отображает ошибки валидации и сообщения об успешной отправке.
Транзакции при создании заявок
Создание заявки включает несколько операций: поиск или создание клиента, создание самой заявки, прикрепление файлов. Все эти операции обернуты в транзакцию базы данных.
Если любая из операций завершится с ошибкой, все изменения будут откачены. Это гарантирует целостность данных.
Безопасность
CSRF защита: Все формы защищены от CSRF атак. В виджете токен передается через meta-тег и добавляется к AJAX запросам.
Валидация файлов: Проверяется тип загружаемых файлов и их размер. Принимаются только документы и изображения распространенных форматов.
Авторизация: Доступ к админ-панели защищен middleware. Проверяется не только факт аутентификации, но и наличие соответствующей роли.
SQL Injection: Eloquent ORM использует prepared statements для всех запросов, что исключает SQL инъекции.
XSS: Blade автоматически экранирует весь вывод, защищая от межсайтового скриптинга.

Структура базы данных
База данных спроектирована в третьей нормальной форме. Клиенты отделены от заявок, что избегает дублирования данных.
Таблица customers содержит уникальные ограничения на email и телефон. Это обеспечивает невозможность создания дубликатов.
Таблица tickets связана с customers через внешний ключ с каскадным удалением. При удалении клиента автоматически удаляются все его заявки.
Для оптимизации запросов созданы индексы на полях, которые часто используются в WHERE и JOIN условиях: phone_number, email, status, created_at.

Производительность
Eager Loading: В местах, где требуется доступ к связанным данным, используется загрузка связей. Это предотвращает проблему N+1 запросов.
Пагинация: Список заявок выводится с пагинацией по 20 записей на страницу. Это снижает нагрузку на БД и ускоряет рендеринг страницы.
Индексация: Добавлены индексы на часто запрашиваемые поля для ускорения выборки данных.



Рекомендации по улучшению
Уведомления
Добавить систему уведомлений для менеджеров. При создании новой заявки отправлять email или push-уведомление. Можно интегрировать Telegram или Slack боты для мгновенных оповещений.
Расширенная статистика
Текущая статистика показывает только количественные показатели. Можно добавить:

Средне время обработки заявки
Распределение по часам дня и дням недели
Топ источников заявок (если добавить поле источника)
Конверсию из новой заявки в обработанную

Комментарии к заявкам.
Добавить возможность менеджерам оставлять внутренние заметки по заявкам. Это полезно для коммуникации между сотрудниками и фиксации хода работы.
Потребуется новая таблица comments с связью many-to-one к tickets. В интерфейсе добавить секцию с историей комментариев.
История изменений
Логировать все изменения статусов заявок с указанием времени и пользователя. Это создаст полную картину работы с заявкой.
Можно использовать пакет spatie/laravel-activitylog или создать собственную таблицу ticket_history.
Экспорт данных
Реализовать экспорт заявок в Excel. Полезно для отчетности и анализа данных в сторонних инструментах.
Laravel Excel пакет предоставляет удобный API для генерации файлов с настраиваемыми колонками и форматированием.
Интеграции
Добавить webhooks для отправки данных о новых заявках во внешние системы. Это позволит интегрировать mini-CRM с существующими CRM системами  или инструментами аналитики.

GET /api/tickets - получение списка с фильтрами
GET /api/tickets/{id} - детали конкретной заявки
PATCH /api/tickets/{id} - обновление заявки
Для защиты добавить аутентификацию через Laravel Sanctum и API токены.

Развертывание
Проект готов к развертыванию через Docker Compose. Все зависимости описаны в конфигурационных файлах.
Для production окружения рекомендуется:

Настроить SSL сертификаты для HTTPS
Использовать отдельный сервер для MySQL
Настроить Redis для кеша и очередей
Настроить резервное копирование базы данных
Использовать CDN для статических файлов

Процесс деплоя можно автоматизировать через CI/CD pipeline (GitHub Actions, GitLab CI).

Тестирование
В проекте заложена основа для тестирования. Созданы Feature тесты для проверки API endpoints и функционала админ-панели.
Для полного покрытия рекомендуется добавить:

Unit тесты для сервисов и репозиториев
Тесты производительности для проверки скорости работы при большом количестве данных


Заключение.
Проект реализует все базовые требования для системы сбора заявок. Архитектура позволяет легко расширять функционал без рефакторинга существующего кода.
Код соответствует современным стандартам разработки на Laravel. Использованы проверенные паттерны и библиотеки.
Система готова к использованию в production среде после базовой настройки security параметров и окружения.
